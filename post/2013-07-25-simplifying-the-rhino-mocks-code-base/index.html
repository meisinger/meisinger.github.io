<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Meisinger Two"><meta property="og:type" content="article"><meta property="og:image" content="https://meisinger.github.io//assets/images/header-code.jpg"><meta property="twitter:image" content="https://meisinger.github.io//assets/images/header-code.jpg"><meta name=title content="Simplifying the Rhino Mocks Code Base"><meta property="og:title" content="Simplifying the Rhino Mocks Code Base"><meta property="twitter:title" content="Simplifying the Rhino Mocks Code Base"><meta name=description content="A friendly blog covering my journey through software development over the past twenty years"><meta property="og:description" content="A friendly blog covering my journey through software development over the past twenty years"><meta property="twitter:description" content="A friendly blog covering my journey through software development over the past twenty years"><meta property="og:url" content="https://meisinger.github.io/post/2013-07-25-simplifying-the-rhino-mocks-code-base/"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=/img/favicon.ico><title>Simplifying the Rhino Mocks Code Base - Meisinger Two</title><link rel=canonical href=/post/2013-07-25-simplifying-the-rhino-mocks-code-base/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css integrity=sha512-... crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/main.css></head><body><nav><div><div class=title-container><button type=button>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=site-title href=/>Meisinger Two
<span class=site-slogan>Soul Proprietor</span></a></div><div class=menu-items-container><ul class=menu-items><li><a href=/>Home</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></div></div><script>var $toggle=document.querySelector(".navbar-toggle");$toggle.addEventListener("click",toggle_navbar);function toggle_navbar(){var t=document.querySelector("#huxblog_navbar"),n=document.querySelector(".navbar-collapse");t.className.indexOf("in")>0?(t.className=" ",setTimeout(function(){t.className.indexOf("in")<0&&(n.style.height="0px")},400)):(n.style.height="auto",t.className+=" in")}</script></nav><article><section class=header><h2 data-label=title>Simplifying the Rhino Mocks Code Base</h2><h6 data-label=reading-time><i class="fa fa-clock"></i>
4 minute read</h6></section><section class=content><p>It has been an interesting last couple of days.</p><p>I finished converting all of the existing unit tests from using Record/Replay syntax to the Arrange/Act/Assert (AAA) syntax.
Oddly enough this lead to a few extra unit tests that were not previously being executed.
These newly discovered unit tests could have been removed due to relevance or performance but for whatever reason, they have been added back.
I did find that there were a few (eleven in fact) that were no longer relevant and needed to be “skipped.”
They are all passing now so… mission accomplished.</p><p>With this done I started turning toward the main code base. And… here we go.</p><h3 id=intercepting-the-interceptors>Intercepting the Interceptors</h3><p>Things started out simple enough; moved similar concerns into a different namespace, removed “generated” files minor code corrections.
I then moved onto simple refactoring like reducing nesting and leveraging <code>TryGetValue</code> on a <strong>Dictionary</strong>.
Everything was going well. I then started to tackle the interceptors and invocation actions.</p><p>If you didn’t already know, Rhino Mocks (as with many other frameworks) utilizes <a href=http://www.castleproject.org/>Castle Windsor</a> to create proxies
and intercept method calls (via <strong>DynamicProxy</strong>). This gives us the ability to create proxies for interfaces, delegates and classes that can then have calls intercepted.
Some of the methods, however, are from the base <strong>System.Object</strong> class which everything in the .Net framework inherits.
As it turns out, you can actually configure Castle Windsor to ignore these methods.
If any method is ignored, however, they are never called which leads to some interesting issues with this like equality and comparison.</p><p>Rhino Mocks current solution for this is to intercept these calls and check to see if the method belongs to <strong>System.Object</strong>.
If the method does belong to <strong>System.Object</strong> then the method is allowed to <em>proceed</em>. This type of “checking” continues for things like properties and events.</p><p>I was a little taken back when I came across this. Not because it was being done but how it was being accomplished.
As I started to refactor this code I came to the realization that <a href=http://www.castleproject.org/>Castle Windsor</a> supports something very similar through something
called the <strong>IInterceptorSelector</strong> interface. When this interface is implemented it allows you to choose which interceptor should handle the method.
By adding an implementation of this interface and a few more interceptors, all of the existing code and constructs can be removed.</p><h3 id=one-step-forward-two-steps-back>One Step Forward, Two Steps Back</h3><p>It would have been great to stop right there. As you might have guessed; that didn’t happen.</p><p>After this minor success I turned my focus on the <strong>MethodOptions</strong> that are returned when you create an expectation.
I decided that since the system knew when a <code>Void</code> method was being called there should be no reason to return <strong>MethodOptions</strong> with a <code>Return</code> method available.
Along the same lines, <code>Return</code> method (when it is available) should be allowed to take a <strong>Func</strong> to return the value.</p><p>Diving into this lead me to understand Record/Replay is much more than just a syntax but is the only way Rhino Mocks currently works.
When using the AAA syntax, behind the scenes, Rhino Mocks transition the “state” from Replay to Record and back to Replay.
Kind of sounds like a lot of steps doesn’t it? Just a tad.</p><p>Rather than perpetuating the current approach, a simpler strategy is underway.
This strategy does away with the various “states” and puts the onus on the code creating the expectation.
The AAA syntax conforms to this nicely since there is really only one way create a expectation.
Based on my estimates, this strategy should reduce the code base by around 30 classes.
Clearly there will be additional classes added but will be geared towards usability rather than internal plumbing.</p><p>I am planning on having a working code set with a majority of the changes completed within the next few weeks.
Some of these modifications can be done in the existing code base in which case I’ll cut a minor release.
Should be exciting!</p></section><section class=footer><div class=tags><label>Tags:</label><div data-type=taxonomy><a href=/tags/rhino-mocks title="Rhino Mocks">Rhino Mocks</a></div></div><div class=categories><label>Categories:</label><div data-type=taxonomy><a href=/categories/development title=Development>Development</a></div></div><h6 data-label=meta>Posted on Thursday, July 25, 2013</h6></section><section class=navigation><a href=/post/2013-07-03-if-you-give-a-rhino-a-cookie/>Previous
</a><a href=/post/2013-08-13-am-i-just-getting-lazy/>Next</a></section></article><footer><ul><li><a href=mailto:mike.meisinger@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/meisinger><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><div data-label=copyright>Copyright &copy; 2025 Mike Meisinger</div></footer></body></html>