<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Meisinger Two"><meta property="og:type" content="article"><meta property="og:image" content="https://meisinger.github.io//assets/images/header-code.jpg"><meta property="twitter:image" content="https://meisinger.github.io//assets/images/header-code.jpg"><meta name=title content="NServiceBus - Fifteen Minutes..."><meta property="og:title" content="NServiceBus - Fifteen Minutes..."><meta property="twitter:title" content="NServiceBus - Fifteen Minutes..."><meta name=description content="A friendly blog covering my journey through software development over the past twenty years"><meta property="og:description" content="A friendly blog covering my journey through software development over the past twenty years"><meta property="twitter:description" content="A friendly blog covering my journey through software development over the past twenty years"><meta property="og:url" content="https://meisinger.github.io/post/2009-11-10-nservicebus-fifteen-minutes/"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=/img/favicon.ico><title>NServiceBus - Fifteen Minutes... - Meisinger Two</title><link rel=canonical href=/post/2009-11-10-nservicebus-fifteen-minutes/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css integrity=sha512-... crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/main.css></head><body><nav><div><div class=title-container><button type=button>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=site-title href=/>Meisinger Two
<span class=site-slogan>Soul Proprietor</span></a></div><div class=menu-items-container><ul class=menu-items><li><a href=/>Home</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></div></div><script>var $toggle=document.querySelector(".navbar-toggle");$toggle.addEventListener("click",toggle_navbar);function toggle_navbar(){var t=document.querySelector("#huxblog_navbar"),n=document.querySelector(".navbar-collapse");t.className.indexOf("in")>0?(t.className=" ",setTimeout(function(){t.className.indexOf("in")<0&&(n.style.height="0px")},400)):(n.style.height="auto",t.className+=" in")}</script></nav><article><section class=header><h2 data-label=title>NServiceBus - Fifteen Minutes...</h2><h6 data-label=reading-time><i class="fa fa-clock"></i>
6 minute read</h6></section><section class=content><p>After downloading the assemblies I was ready to create my first sample application using NServiceBus.
From what I can tell, a lot of time and effort has gone into building the <strong>NServiceBus.Host</strong> executable so if you plan on using it… you’re in luck,
there are plenty of examples out there on how to use it. If you don’t want to use it, however, get ready for some digging
(take a guess on which direction I went in). Hopefully this post will serve as a good example of how to handle things when you don’t want to use <strong>NServiceBus.Host</strong>.
Time will tell…</p><p>The most basic example is sending a message. Note that this is not publishing a message but simply sending a message.
To send a message you will need something that sends the message and something that will receive the message.
Go ahead and create two console projects: 1) “Sender” and 2) “Receiver”.</p><p>You will need to be able to define a message that both the sender and receiver will be able to understand so go ahead and create library project
(name it “Messages” for now to keep things simple).</p><p>Again, doing the most simple thing possible, add a reference to “NServiceBus.dll” to the “Messages” project.
Create a new class, add the “Serializable”  attribute, and have the class implement the “IMessage” interface.
This interface is nothing more than a indication to NServiceBus that it can be used as a message.
And since we are going to be passing this class around as a message we need to be able to serialize it across the wire so… don’t forget the “Serializable” attribute.</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#82aaff>[Serializable]</span>
</span></span><span style=display:flex><span><span style=color:#c099ff>public</span> <span style=color:#c099ff>class</span> <span style=color:#ff966c>ExampleMessage</span> : IMessage {
</span></span><span style=display:flex><span>  <span style=color:#c099ff>public</span> <span style=color:#4fd6be>int</span> Id { <span style=color:#c099ff>get</span>; <span style=color:#c099ff>set</span>; }
</span></span><span style=display:flex><span>  <span style=color:#c099ff>public</span> <span style=color:#4fd6be>string</span> Message { <span style=color:#c099ff>get</span>; <span style=color:#c099ff>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A “message” can be thought of as a Data Transfer Object (DTO) in that the message should only contain data and really shouldn’t contain any methods or logic.
There can be some interaction with the data like formatting or structuring but avoid putting any logic. Remember that this is going to be serialized.</p><p>From here add the “Messages” project as a reference to the “Sender” and “Receiver” console applications.
While we are at it, go ahead and add a reference to “NServiceBus.dll” and “NServiceBus.Core.dll”.</p><p>Up to now we have three projects: Messages (contains our message class), Sender (the application that will send the message) and,
Receiver (the application that will receive the message). So far so good.</p><h3 id=the-sender>The Sender</h3><p>So now we want the “Sender” application to send a message out into the world.
Prior to being able to send a message we first have to instantiate a service bus (for NServiceBus this is an IBus).
NServiceBus has a “fluent interface” class named “Configure” that uses an Inversion of Control (IoC) container to build up, configure,
and create an instance of a service bus. By default this is done through Spring.Net which is all nice and good but I prefer to use
StructureMap so… that is what I choose to use here. The only difference in this example is the “StructureMapBuilder” call which tells
NServiceBus to use StructureMap as the IoC container. If you leave this line out… you will use Spring.Net.</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#4fd6be>var</span> bus = Configure.With()
</span></span><span style=display:flex><span>  .StructureMapBuilder()
</span></span><span style=display:flex><span>  .XmlSerializer()
</span></span><span style=display:flex><span>  .MsmqTransport()
</span></span><span style=display:flex><span>  .IsTransactional(<span style=color:#ffc777>false</span>)
</span></span><span style=display:flex><span>  .PurgeOnStartup(<span style=color:#ffc777>false</span>)
</span></span><span style=display:flex><span>  .UnicastBus()
</span></span><span style=display:flex><span>  .ImpersonateSender(<span style=color:#ffc777>false</span>)
</span></span><span style=display:flex><span>  .CreateBus()
</span></span><span style=display:flex><span>  .Start();
</span></span></code></pre></div><p>Now we have a service bus that we can send messages with.
In order to send a message all we need to do is new up an instance of our class from the “Messages” project and call the <strong>Send</strong> method from our service bus instance.
For this simple example we do this in a while loop where each time we hit “Enter” we send a message:</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#c099ff>while</span> (Console.ReadLine() != <span style=color:#ffc777>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#4fd6be>var</span> message = <span style=color:#c099ff>new</span> ExampleMessage(<span style=color:#ffc777>1</span>, <span style=color:#c3e88d>&#34;My First Example&#34;</span>);
</span></span><span style=display:flex><span>  bus.Send(message);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally it is time to configure our “Sender” application. Here we need to add an Application Configuration File (App.config).
Since we are sending a message we need to configure our MSMQ Transport and our Unicast Bus.</p><p><em>NOTE: Unlike other configuration sections you cannot “name” the section something different.
The following section “names” must be as they appear or they do not work. Not 100% why this is but… if you don’t then it will not work</em></p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#c099ff>&lt;configSections&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#c099ff>&lt;section</span> <span style=color:#82aaff>name=</span><span style=color:#c3e88d>&#34;MsmqTransportConfig&#34;</span> <span style=color:#82aaff>type=</span><span style=color:#c3e88d>&#34;NServiceBus.Config.MsmqTransportConfig, NServiceBus.Core&#34;</span> <span style=color:#c099ff>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#c099ff>&lt;section</span> <span style=color:#82aaff>name=</span><span style=color:#c3e88d>&#34;UnicastBusConfig&#34;</span> <span style=color:#82aaff>type=</span><span style=color:#c3e88d>&#34;NServiceBus.Config.UnicastBusConfig, NServiceBus.Core&#34;</span> <span style=color:#c099ff>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c099ff>&lt;/configSections&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c099ff>&lt;MsmqTransportConfig</span> <span style=color:#82aaff>InputQueue=</span><span style=color:#c3e88d>&#34;MySenderQueue&#34;</span> <span style=color:#82aaff>ErrorQueue=</span><span style=color:#c3e88d>&#34;error&#34;</span> <span style=color:#82aaff>NumberOfWorkerThreads=</span><span style=color:#c3e88d>&#34;1&#34;</span> <span style=color:#82aaff>MaxRetries=</span><span style=color:#c3e88d>&#34;5&#34;</span> <span style=color:#c099ff>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c099ff>&lt;UnicastBusConfig</span> <span style=color:#82aaff>DistributorControlAddress=</span><span style=color:#c3e88d>&#34;&#34;</span> <span style=color:#82aaff>DistributorDataAddress=</span><span style=color:#c3e88d>&#34;&#34;</span> <span style=color:#82aaff>ForwardReceivedMessagesTo=</span><span style=color:#c3e88d>&#34;&#34;</span><span style=color:#c099ff>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#c099ff>&lt;MessageEndpointMappings&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#c099ff>&lt;add</span> <span style=color:#82aaff>Messages=</span><span style=color:#c3e88d>&#34;MessageTypes&#34;</span> <span style=color:#82aaff>Endpoint=</span><span style=color:#c3e88d>&#34;MyReceiverQueue&#34;</span> <span style=color:#c099ff>/&gt;</span> 
</span></span><span style=display:flex><span>  <span style=color:#c099ff>&lt;/MessageEndpointMappings&gt;</span> 
</span></span><span style=display:flex><span><span style=color:#c099ff>&lt;/UnicastBusConfig&gt;</span>
</span></span></code></pre></div><p>Right now the important pieces to cover in the configuration are: InputQueue, Endpoint, and Messages.</p><p><code>InputQueue</code> defines where this service bus can receive messages. Since the “Sender” is never going to receive a message in this example we can safely put anything we want here. For consistency I put “MySenderQueue”.</p><p><code>Endpoint</code> defines where this service bus will send messages. This is a really important setting. We will be using this value later when we configure the “Receiver”.</p><p><code>Messages</code> defines what type of messages this service bus will send to the <code>Endpoint</code>. Here we can break this up to be type specific but for this example we will simply instruct the service bus to send all of the messages from our “Messages” project to the <code>Endpoint</code>.</p><p><strong>The Receiver</strong></p><p>Now we want the “Receiver” to receive messages from the world. Prior to being able to receive messages we first have to instantiate another service bus similar to the way we did in our “Sender” project. The only real big difference in configuring this service bus is telling NServiceBus to load in our message handlers.</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#4fd6be>var</span> bus = Configure.With()
</span></span><span style=display:flex><span>  .StructureMapBuilder()
</span></span><span style=display:flex><span>  .XmlSerializer()
</span></span><span style=display:flex><span>  .MsmqTransport()
</span></span><span style=display:flex><span>  .IsTransactional(<span style=color:#ffc777>false</span>)
</span></span><span style=display:flex><span>  .PurgeOnStartup(<span style=color:#ffc777>false</span>)
</span></span><span style=display:flex><span>  .UnicastBus()
</span></span><span style=display:flex><span>  .ImpersonateSender(<span style=color:#ffc777>false</span>)
</span></span><span style=display:flex><span>  .LoadMessageHandlers()
</span></span><span style=display:flex><span>  .CreateBus()
</span></span><span style=display:flex><span>  .Start();
</span></span></code></pre></div><p>Since we don’t want our “Receiver” application closing as soon as we bring it up we need to add a little bit of code to make sure it sticks around while we test:</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span>Console.ReadLine();
</span></span></code></pre></div><p>If you notice the only difference between the “Sender” and the “Receiver” is the <strong>LoadMessageHandlers</strong> call.
So in order for NServiceBus to load our message handlers… we need to have a message handler.
To do this simply add a new class and implement the <code>IHandleMessages&lt;></code> interface:</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#c099ff>public</span> <span style=color:#c099ff>class</span> <span style=color:#ff966c>ExampleMessageHandler</span> : IHandleMessages&lt;examplemessage&gt; {
</span></span><span style=display:flex><span>  <span style=color:#c099ff>public</span> <span style=color:#c099ff>void</span> Handle(ExampleMessage message) {
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#c3e88d>&#34;I got an example message... now what?&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally it is time to configure our “Receiver” application. Here we need to add an Application Configuration File (App.config).
Since we are only receiving messages we only need to configure our MSMQ Transport (no need to configure the Unicast Bus).</p><div class=highlight><pre tabindex=0 style=color:#c8d3f5;background-color:#222436;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#c099ff>&lt;configSections&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#c099ff>&lt;section</span> <span style=color:#82aaff>name=</span><span style=color:#c3e88d>&#34;MsmqTransportConfig&#34;</span> <span style=color:#82aaff>type=</span><span style=color:#c3e88d>&#34;NServiceBus.Config.MsmqTransportConfig, NServiceBus.Core&#34;</span> <span style=color:#c099ff>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c099ff>&lt;/configSections&gt;</span> 
</span></span><span style=display:flex><span><span style=color:#c099ff>&lt;MsmqTransportConfig</span> <span style=color:#82aaff>InputQueue=</span><span style=color:#c3e88d>&#34;MyReceiverQueue&#34;</span> <span style=color:#82aaff>ErrorQueue=</span><span style=color:#c3e88d>&#34;error&#34;</span> <span style=color:#82aaff>NumberOfWorkerThreads=</span><span style=color:#c3e88d>&#34;1&#34;</span> <span style=color:#82aaff>MaxRetries=</span><span style=color:#c3e88d>&#34;5&#34;</span> <span style=color:#c099ff>/&gt;</span> 
</span></span></code></pre></div><p>In order to receive messages properly we need to make sure that the <code>InputQueue</code> value is the same as the <code>Endpoint</code> value from the “Sender” configuration.
For this example it is “MyReceiverQueue”.</p><h3 id=done>Done</h3><p>Now you are ready to go and start sending messages from the “Sender” to the “Receiver”.</p><p>To do so simply right click the “Sender” project and click “Start new instance” from the “Debug” submenu.
After this console app is up and running right click the “Receiver” project and click “Start new instance” from the “Debug” submenu.
With both console applications up and running hit “Enter” from the “Sender” window and watch the message appear in the “Receiver” window.</p><h3 id=summary>Summary</h3><p>All and all I would say that this took about fifteen to twenty minutes to get setup and running.
That is pretty impressive especially when you start digging into what is actually happening in the background.</p><p>In future posts we can go over Publish and Subscribe, Request and Reply, and talk about the Distributor (which is some really neat stuff).</p></section><section class=footer><div class=tags><label>Tags:</label><div data-type=taxonomy><a href=/tags/nservicebus title=NServiceBus>NServiceBus</a></div></div><div class=categories><label>Categories:</label><div data-type=taxonomy><a href=/categories/development title=Development>Development</a></div></div><h6 data-label=meta>Posted on Tuesday, November 10, 2009</h6></section><section class=navigation><a href=/post/2009-04-30-solid-liskov-substitution-principle-lsp/>Previous
</a><a href=/post/2010-08-21-head-in-the-clouds/>Next</a></section></article><footer><ul><li><a href=mailto:mike.meisinger@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/meisinger><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><div data-label=copyright>Copyright &copy; 2025 Mike Meisinger</div></footer></body></html>